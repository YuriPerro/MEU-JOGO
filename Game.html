<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Flappy Gun </title>
    <script src="tiros.js"></script>
    <script src="Sprite.js"></script>
    <script src="Obstaculos.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="enemy.js"></script>
    <link rel="stylesheet" href="style.css"/>
    <style>
    </style>
</head>

<body>
    <h1>• Flappy Gun •</h1>
    
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("player", "Assets/avatar1.png");
        var fundoMng = new AssetsManager();
        fundoMng.loadImage("bg", "Assets/bg_01.png");
        
        var canvas, pontos = 0, LARGURA, recorde = 0, ALTURA, 
        ctx, frames = 0, velocidade = 5, estadoAtual;
        
        //Adicionando AssetsManager a Cena 1
        //var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets:assetsMng})
        
        var bloco = new Sprite({});
        var OBS = new Obstaculos({});
        var inimigo = new enemy({});
        var tirosVetor = [];
        var dt, anterior = 0;
        var teclas = {
            espaco: 0,
            stop: 0,
        }
        
        estados = {
            jogar: 0,
            jogando: 1,
            perdeu: 2
        },
        chao = {
            y: 433,
            altura: 30,
            cor: "#black",
            desenha: function () {
                ctx.fillStyle = this.cor;
                ctx.fillRect(0, this.y, LARGURA, this.altura);
            }
        },
        
        addEventListener("keydown", function(e){
            if (e.keyCode == 38){
                bloco.pula();
            }
            if (e.keyCode == 87){
                teclas.espaco = 1;
            }
        });
        
        addEventListener("keyup", function(e){
            if(e.keyCode == 87){
                teclas.espaco = 0;
            }
        });
        
        addEventListener("mousedown", function clique(e) {
            if (estadoAtual == estados.jogar) {
                OBS.limpa();
                velocidade = 5;
                estadoAtual = estados.jogando;
                bloco.gravidade = 0.5;
            }
            else if (estadoAtual == estados.perdeu) {
                bloco.y = 220;
                bloco.gravidade = 0;
                estadoAtual = estados.jogar;
            }
        });
        
        function main() {                                                   //Função main 
            ALTURA = window.innerHeight;
            LARGURA = window.innerWidth;
            if (LARGURA >= 500) {
                LARGURA = window.innerWidth - 100;
                ALTURA = 500;
            }
            canvas = document.createElement("canvas");
            canvas.width = LARGURA;
            canvas.height = ALTURA;
            
            canvas.style.border = "5px solid black";
            ctx = canvas.getContext("2d");
            
            document.body.appendChild(canvas);
            estadoAtual = estados.jogar;
            requestAnimationFrame(roda);
        }
        
        function roda(t) {
            dt = (t - anterior)/1000;
            atualiza();
            desenha();
            if(pontos > 0){
                inimigo.desenha(ctx);
                inimigo.mover(dt);
            }
            anterior = t
            ctx.drawImage(assetsMng.img("player"), bloco.x, bloco.y-5, 50, 50);
            
            
            if(teclas.espaco && teclas.stop == 0 && bloco.atirando <= 0){
                var tiro = new tiros({
                    x: bloco.x+35,
                    y: bloco.y +23  ,
                    w: 10,
                    h: 10,
                    vx: 700,
                    color: "black",
                });
            
                tirosVetor.push(tiro);
                bloco.atirando = 1/10;
        }
        
        bloco.mover(dt);
        
        for (var i = 0; i < tirosVetor.length; i++) {       
                tirosVetor[i].mover(dt);
            }
            for (var i = 0; i < tirosVetor.length; i++) {     
                tirosVetor[i].desenha(ctx);
            }
            for (var i = 0; i < tirosVetor.length; i++) {
                if (tirosVetor[i].x > canvas.width)
                tirosVetor.splice(i, 1);
            }
            
            requestAnimationFrame(roda);
        }
        
        function atualiza() {
            frames++;
            
            if (estadoAtual == estados.jogando) {
                OBS.atualiza(bloco);
                bloco.colidiuCom(OBS);
                bloco.atualiza(chao);
                inimigo.colidiu(tirosVetor);
                inimigo.atualiza(estadoAtual, estados);
                teclas.stop = 0;
            }
            
            if(estadoAtual == estados.perdeu){
                tirosVetor = [];
                teclas.stop = 1;
            }
            if(estadoAtual == estados.jogar){
                tirosVetor = [];
                teclas.stop = 1;
            }
        }
        function desenha() {
            //ctx.fillStyle = "lightgreen";              //Cor da canvas
            ctx.fillRect(0, 0, LARGURA, ALTURA);    //Localizaçao da canvas
            ctx.drawImage(fundoMng.img("bg"), 0, 0, LARGURA, ALTURA);
            
            if (estadoAtual == estados.jogar) {
                ctx.fillStyle = "white";                                        //Cor do retangulo do play
                ctx.fillRect((LARGURA / 2) - 100, (ALTURA / 2) - 50, 170, 68); //Localizaçao

                ctx.fillStyle = "green";                                    //Cor do PLAY
                ctx.font = "50px bold arial";                               //Tipografia do PLAY
                ctx.fillText("PLAY", (LARGURA / 2) - 80, (ALTURA / 2));     //Localizaçao do PLAY
            }
            else if (estadoAtual == estados.perdeu) {
                ctx.fillStyle = "white";                                //Fundo do PERDEU
                ctx.fillRect(0, (ALTURA / 2) - 150, LARGURA, 68);       //Localizaçao do PERDEU
                ctx.fillStyle = "white";                          //Fundo do New Game 
                ctx.fillRect((LARGURA / 2) - 110, (ALTURA / 2) + 20, 150, 40);  // Localização 

                ctx.fillStyle = "black";                                            //Cor do Record
                ctx.font = "35px bold arial";                                       //Tipografia
                ctx.fillText(recorde, (LARGURA / 2) + 15, (ALTURA / 2) - 10);       //Localizaçao da pontuaçao
                ctx.fillText("Record: ", (LARGURA / 2) - 110, (ALTURA / 2) - 12);   //Localizaçao da escrita
                
                ctx.fillStyle = "black";                                //Cor do New Game
                ctx.font = "25px bold moncspace";                       //Tipografia do New Game
                ctx.fillText("New Game", (LARGURA / 2) - 92, (ALTURA / 2) + 48);    //Localizaçao
                ctx.fillStyle = "red";                                  //Cor do Perdeu 
                ctx.font = "50px bold moncspace";                       //Tipografia do Perdeu     
                ctx.fillText("Tenta dnv campeão", (LARGURA / 2) - 230, (ALTURA / 2) - 100);    //Localizaçao
            }
            else if (estadoAtual == estados.jogando) {
                OBS.desenha();
                ctx.fillStyle = "black";
                ctx.font = "35px bold impact";
                ctx.fillText(pontos, 128, 52);
                ctx.fillText("Score:", 30, 50);
            }
            bloco.desenha(ctx);
            //chao.desenha();
        }
        main();
        </script>
</body>
</html>